<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="ko" xml:lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>검색 필터</title>
  <style>
    body {
      font-family: sans-serif;
    }

    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 150px;
    }

    select:disabled {
      background-color: #f2f2f2;
    }
  </style>
</head>

<body>
  <h1>검색 필터</h1>

  <div class="filter-container">
    <div class="filter-group">
      <label for="year-order">연도/차수</label>
      <select id="year-order">
        <option value="">-- 선택 --</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="respondent">응답주체</label>
      <select id="respondent" disabled>
        <option value="">-- 선택 --</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="category-major">카테고리(대분류)</label>
      <select id="category-major" disabled>
        <option value="">-- 선택 --</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="category-medium">카테고리(중분류)</label>
      <select id="category-medium" disabled>
        <option value="">-- 선택 --</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="category-minor">카테고리(소분류)</label>
      <select id="category-minor" disabled>
        <option value="">-- 선택 --</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="category-detailed">카테고리(세분류)</label>
      <select id="category-detailed" disabled>
        <option value="">-- 선택 --</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="question">문항</label>
      <select id="question" disabled>
        <option value="">-- 선택 --</option>
      </select>
    </div>
  </div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const processedData = /*[[${data}]]*/ null;

    console.log(processedData);

    if (!processedData) {
      console.error("Processed data is null or undefined.");
      // Optionally, disable all selects or show a message
    } else {
      const {
        yearOrderData,
        respondentData,
        categoryMajorData,
        categoryMediumData,
        categoryMinorData,
        categoryDetailedData,
        questionData,
      } = processedData;

      const selects = {
        yearOrder: document.getElementById("year-order"),
        respondent: document.getElementById("respondent"),
        categoryMajor: document.getElementById("category-major"),
        categoryMedium: document.getElementById("category-medium"),
        categoryMinor: document.getElementById("category-minor"),
        categoryDetailed: document.getElementById("category-detailed"),
        question: document.getElementById("question"),
      };

      const allData = [
        ...yearOrderData,
        ...respondentData,
        ...categoryMajorData,
        ...categoryMediumData,
        ...categoryMinorData,
        ...categoryDetailedData,
        ...questionData,
      ];

      const selectOrder = [
        { key: "yearOrder", data: yearOrderData },
        { key: "respondent", data: respondentData },
        { key: "categoryMajor", data: categoryMajorData },
        { key: "categoryMedium", data: categoryMediumData },
        { key: "categoryMinor", data: categoryMinorData },
        { key: "categoryDetailed", data: categoryDetailedData },
        { key: "question", data: questionData },
      ];

      function resetAndDisable(...selectElements) {
        selectElements.forEach((select) => {
          select.options.length = 1; // Keep only the first option (-- 선택 --)
          select.disabled = true;
          select.value = "";
        });
      }

      function populateSelect(select, items) {
        if (!items || items.length === 0) {
          select.disabled = true;
          return;
        }
        items.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.name;
          select.appendChild(opt);
        });
        select.disabled = false;
      }

      function getChildren(parentId, data) {
        return data.filter((item) => item.parentId === parentId);
      }

      // Initial population of the first select box
      populateSelect(selects.yearOrder, getChildren(null, yearOrderData));

      // Add event listeners to all select boxes
      selectOrder.forEach(({ key }, index) => {
        const currentSelect = selects[key];

        currentSelect.addEventListener("change", () => {
          const selectedId = currentSelect.value;

          // Disable all subsequent selects
          const selectsToReset = selectOrder
            .slice(index + 1)
            .map((item) => selects[item.key]);
          resetAndDisable(...selectsToReset);

          // Populate the next select
          const nextSelectInfo = selectOrder[index + 1];
          if (selectedId && nextSelectInfo) {
            const children = getChildren(selectedId, nextSelectInfo.data);
            populateSelect(selects[nextSelectInfo.key], children);
          }
        });
      });
    }

    /*]]>*/
  </script>
</body>

</html>
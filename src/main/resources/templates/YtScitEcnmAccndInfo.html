<!DOCTYPE html>
<html lang="ko" xml:lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>청년사회경제실태조사</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>

    <link as="font" crossorigin="anonymous" rel="preload" th:href="@{/fonts/NotoSansKR-Regular.woff2}" type="font/woff2"/>
    <link as="font" crossorigin="anonymous" rel="preload" th:href="@{/fonts/NotoSansKR-Medium.woff2}" type="font/woff2"/>
    <link as="font" crossorigin="anonymous" rel="preload" th:href="@{/fonts/NotoSansKR-Bold.woff2}" type="font/woff2"/>
    <link as="font" crossorigin="anonymous" rel="preload" th:href="@{/fonts/NotoSansKR-Light.woff2}" type="font/woff2"/>

    <link rel="icon" th:href="@{/images/favicon.ico}">
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css"/>
</head>

<body>
<div id="wrap">
    <div th:replace="~{fragments/sidenav :: sideNav}"></div>
    <div class="content-wrap">
        <!-- 모바일 헤더 -->
        <header class="m-header mo">
            <button class="btn-menu">메뉴</button>
        </header>

        <div id="mainContent">
            <h1>청년사회경제실태조사</h1>
            <div class="filter-container">
                <div class="filter-header">
                    <h2>검색 필터</h2>
                    <hr>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="year">설문연도<span class="asterisk">*</span></label>
                        <select id="year">
                            <option value="">선택</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group category-group">
                        <span class="form-item-label">카테고리<span class="asterisk">*</span></span>
                        <div class="category-selects">
                            <div class="filter-group">
                                <label for="category-major">대분류</label>
                                <select disabled id="category-major">
                                    <option value="">선택</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="category-medium">중분류</label>
                                <select disabled id="category-medium">
                                    <option value="">선택</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="category-minor">소분류</label>
                                <select disabled id="category-minor">
                                    <option value="">선택</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="category-detailed">세분류</label>
                                <select disabled id="category-detailed">
                                    <option value="">선택</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="question">문항</label>
                                <select disabled id="question">
                                    <option value="">선택</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <span class="form-item-label">배너변수</span>
                        <div class="checkbox-group">
                            <label for="gender">성별</label>
                            <input id="gender" name="banner-variable" type="checkbox">
                            <label for="age">연령</label>
                            <input id="age" name="banner-variable" type="checkbox">
                            <label for="region">지역</label>
                            <input id="region" name="banner-variable" type="checkbox">
                        </div>
                    </div>
                </div>
                <div class="btn-container">
                    <button class="btn-reset">초기화</button>
                    <button class="btn-search">조회</button>
                </div>
            </div>
            <div id="api-url-container" class="api-url-wrap" style="display: none;">
                <label for="api-url-display">API 호출 예시 (공공데이터포털 URL)</label>
                <div class="api-url-content">
                    <input id="api-url-display" type="text" disabled readonly>
                    <button id="copy-btn" type="button" class="copy-btn" aria-label="Copy to clipboard">
                        <svg class="w-4 h-4 text-blue-700" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                            <path d="M16 1h-3.278A1.992 1.992 0 0 0 11 0H7a1.993 1.993 0 0 0-1.722 1H2a2 2 0 0 0-2 2v15a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2Zm-3 14H5a1 1 0 0 1 0-2h8a1 1 0 0 1 0 2Zm0-4H5a1 1 0 0 1 0-2h8a1 1 0 0 1 0 2Zm0-5H5a1 1 0 0 1 0-2h2V2h4v2h2a1 1 0 1 1 0 2Z"/>
                        </svg>
                        <span id="copy-feedback" class="copy-feedback-message">복사완료!</span>
                    </button>
                </div>
            </div>
            <div class="result-wrap">
                <div class="filter">
                    <div class="count">총&nbsp;<span id="total-count">0</span>건</div>
                    <div>
                        <label for="page-size-select" style="display: none">페이지당 표시 수</label>
                        <select id="page-size-select" name="page-size">
                            <option value="5">5개씩 보기</option>
                            <option selected value="10">10개씩 보기</option>
                            <option value="15">15개씩 보기</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrap">
                    <table class="tbl-sty01" id="results-table">
                        <caption class="sr-only">청년사회경제실태조사 검색 결과</caption>
                        <colgroup>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                        </colgroup>
                        <thead>
                        <tr>
                            <th scope="col">No.</th>
                            <th scope="col">설문연도</th>
                            <th scope="col">설문조사차수</th>
                            <th scope="col">응답주체명</th>
                            <th scope="col">출력범주명</th>
                            <th scope="col">설문배너변수내용</th>
                            <th scope="col">설문배너분류코드</th>
                            <th scope="col">설문문항아이디</th>
                            <th scope="col">코드북문항내용</th>
                            <th scope="col">응답값</th>
                            <th scope="col">응답명</th>
                            <th class="aiCrtYn" scope="col">인공지능생성여부</th>
                            <th scope="col">사례수</th>
                            <th scope="col">빈도비율</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- pc 페이지네이션 -->
                <div class="pagination-wrap pc">
                    <div class="pagination"></div>
                </div>
                <!-- 모바일 페이지네이션 -->
                <div class="pagination-wrap mo">
                    <div class="pagination"></div>
                </div>
            </div>
        </div>
        <footer>
            <p>세종특별자치시 시청대로370 세종국책연구단지 사회정책동(D동) 한국청소년정책연구원 6/7층</p>
        </footer>
    </div>
</div>
<div class="dim"></div>

<!-- 로딩 스피너 -->
<!-- <div id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: flex; flex-direction: column; align-items: center;">
    <img th:src="@{/images/loading.gif}" alt="로딩 중" style="width: 50px; height: 50px" />
    <span style="margin-top: 10px; font-size: 14px; font-weight: light">Loading</span>
</div> -->

<script th:src="@{/js/common/filter.js}"></script>
<script th:src="@{/js/common/sidenav.js}"></script>
<script th:inline="javascript">
    const url = {
        filter: "/api/filter?surveyName=청년사회경제실태조사",
        table: "/api/ytScitEcnmAccndInfo",
        publicApiBaseUrl: "https://data.nypi.re.kr/openapi/service/api/YtScitEcnmAccndInfo",
    }

    // 1. 이 페이지의 필터 구성을 정의합니다.
    const pageFilterConfig = {
        selects: [
            { key: "year", elementId: "year", data: "yearData", paramName: "srvyYr" },
            { key: "categoryMajor", elementId: "category-major", data: "categoryMajorData" },
            { key: "categoryMedium", elementId: "category-medium", data: "categoryMediumData" },
            { key: "categoryMinor", elementId: "category-minor", data: "categoryMinorData" },
            { key: "categoryDetailed", elementId: "category-detailed", data: "categoryDetailedData" },
            { key: "questionId", elementId: "question", data: "questionData", paramName: "srvyQitemId" }
        ],
        bannerVariables: [
            { elementId: 'gender', paramName: 'svbnClsfCd01', paramValue: 'BANN020200' },
            { elementId: 'age', paramName: 'svbnClsfCd02', paramValue: 'BANN020300' },
            { elementId: 'region', paramName: 'svbnClsfCd03', paramValue: 'BANN020400' }
        ]
    };

    let selectedParams = {};

    function addCommas(numStr) {
        return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function updateTable(items) {
        const tableBody = document.querySelector("#results-table tbody");
        if (!tableBody) return;

        // Clear existing rows
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }

        if (!items || items.length === 0) {
            const noResultsRow = document.createElement('tr');
            const noResultsCell = document.createElement('td');
            noResultsCell.colSpan = 14; // Adjusted colspan to 14 based on HTML header
            noResultsCell.style.textAlign = 'center';
            noResultsCell.textContent = '검색 결과가 없습니다.';
            noResultsRow.appendChild(noResultsCell);
            tableBody.appendChild(noResultsRow);
            return;
        }

        const showAiCol = items.some(item => item["aiCrtYn"] === 'Y');
        if (showAiCol) {
            const aiCrtTh = document.querySelector(".aiCrtYn");
            aiCrtTh.style.display = "table-cell";
        } else {
            const aiCrtTh = document.querySelector(".aiCrtYn");
            aiCrtTh.style.display = "none";
        }

        items.forEach(item => {
            const row = document.createElement('tr');

            const createCell = (text) => {
                const cell = document.createElement('td');
                cell.textContent = text || '';
                return cell;
            };
            row.appendChild(createCell(item.id));
            row.appendChild(createCell(item.srvyYr));
            row.appendChild(createCell(item.srvyExmnCycl));
            row.appendChild(createCell(item.rspnsMnbdNm));
            row.appendChild(createCell(item.otptCtgryNm));
            row.appendChild(createCell(item.svbnVrblCn));
            row.appendChild(createCell(item.svbnClsfCd));
            row.appendChild(createCell(item.srvyQitemId));
            row.appendChild(createCell(item.cbookQitemCn));
            row.appendChild(createCell(item.rspvl));
            row.appendChild(createCell(item.rspnsNm));
            if (showAiCol) {
                row.appendChild(createCell(item.aiCrtYn));
            }
            row.appendChild(createCell(addCommas(item.caseCnt)));
            row.appendChild(createCell(item.freqRt));

            tableBody.appendChild(row);
        });
    };

    function updateTotalCount(totalCount) {
        const countElement = document.getElementById('total-count');
        if (countElement) {
            countElement.textContent = totalCount || 0;
        }
    }

    function displayPublicApiUrl(publicApiBaseUrl, queryString) {
        const publicApiUrl = `${publicApiBaseUrl}?_type=json&${queryString}`;

        const apiUrlContainer = document.getElementById('api-url-container');
        const apiUrlDisplay = document.getElementById('api-url-display');

        if (apiUrlDisplay && apiUrlContainer) {
            apiUrlDisplay.value = publicApiUrl;
            apiUrlContainer.style.display = 'block';
        }
    }

    function performSearch(searchParams, pageNo = 1, numOfRows = 10) {
        const year = document.getElementById('year');
        const categoryMajor = document.getElementById('category-major');
        const categoryMedium = document.getElementById('category-medium');
        const categoryMinor = document.getElementById('category-minor');
        const categoryDetailed = document.getElementById('category-detailed');
        const question = document.getElementById('question');

        if (!searchParams.srvyYr) {
            alert("연도가 선택되지 않았습니다.");
            year.focus();
            return;
        }
        if (!searchParams.srvyQitemId) {
            if (!question.disabled && question.selectedIndex === 0) {
                alert("문항이 선택되지 않았습니다.");
                question.focus();
                return;
            }
            [categoryMajor, categoryMedium, categoryMinor, categoryDetailed].forEach(category => {
                if (!category.disabled && category.selectedIndex === 0) {
                    alert("카테고리가 선택되지 않았습니다.");
                    category.focus();
                    return;
                }
            });
        }

        const queryString = new URLSearchParams({
            ...searchParams,
            pageNo,
            numOfRows
        }).toString();

        fetch(`${url.table}?${queryString}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("데이터 조회에 실패했습니다.\n잠시 후 다시 시도해주세요.");
                }
                return response.json();
            })
            .then(data => {
                selectedParams = { ...searchParams };
                updateTable(data.items);
                updateTotalCount(data.totalCount);
                displayPagination(data.totalCount, data.numOfRows, data.pageNo);
                displayPublicApiUrl(url.publicApiBaseUrl, queryString);
            })
            .catch(error => {
                console.error("검색 중 오류 발생:", error);
                updateTable(null);
                updateTotalCount(0);
            });
    }

    function displayPagination(totalCount, numOfRows, pageNo) {
        const totalPages = Math.ceil(totalCount / numOfRows);
        const paginationContainer = document.querySelector(".pagination");
        paginationContainer.textContent = "";

        if (totalPages > 0) {
            const startPage = Math.floor((pageNo - 1) / 10) * 10 + 1;
            const endPage = Math.min(startPage + 9, totalPages);

            const createButton = (text, classNames = [], disabled = false, dataPage = null) => {
                const button = document.createElement("button");
                button.classList.add("page-btn", ...classNames);
                if (disabled) button.disabled = true;

                const anchor = document.createElement("a");
                anchor.textContent = text;
                button.appendChild(anchor);

                if (dataPage) button.dataset.page = dataPage;

                return button;
            };

            // 처음 버튼
            const firstButton = createButton("처음", ["arrow", "first"], pageNo === 1);
            paginationContainer.appendChild(firstButton);

            // 이전 버튼
            const prevButton = createButton("이전", ["arrow", "prev"], pageNo === 1);
            paginationContainer.appendChild(prevButton);

            // 페이지 번호 버튼
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = createButton(i, [], false, i);
                if (i === pageNo) pageButton.classList.add("active");
                paginationContainer.appendChild(pageButton);
            }

            // 다음 버튼
            const nextButton = createButton("다음", ["arrow", "next"], pageNo === totalPages);
            paginationContainer.appendChild(nextButton);

            // 마지막 버튼
            const lastButton = createButton("마지막", ["arrow", "last"], pageNo === totalPages);
            paginationContainer.appendChild(lastButton);

            // 페이지 버튼 클릭 이벤트
            const buttons = paginationContainer.querySelectorAll(".page-btn");
            buttons.forEach(button => {
                button.addEventListener("click", () => {
                    let clickedPage = parseInt(button.dataset.page, 10);
                    if (!isNaN(clickedPage)) {
                        pageNo = clickedPage;
                    } else if (button.classList.contains("first")) {
                        pageNo = 1;
                    } else if (button.classList.contains("prev")) {
                        pageNo = Math.max(1, pageNo - 10);
                    } else if (button.classList.contains("next")) {
                        pageNo = Math.min(totalPages, pageNo + 10);
                    } else if (button.classList.contains("last")) {
                        pageNo = totalPages;
                    }
                    numOfRows = document.getElementById('page-size-select').value;
                    performSearch(selectedParams, pageNo, numOfRows);
                });
            });
        }
    };

    function addPageSizeChangeEventListener() {
        const pageSizeSelect = document.getElementById('page-size-select');
        if (!pageSizeSelect) return;

        pageSizeSelect.addEventListener('change', () => {
            if (Object.keys(selectedParams).length > 0) {
                const numOfRows = pageSizeSelect.value
                performSearch(selectedParams, 1, numOfRows);
            }
        });
    }
    
    function addCopyButtonEventListener() {
        const copyButton = document.getElementById('copy-btn');
        const apiUrlDisplay = document.getElementById('api-url-display');
        const copyFeedback = document.getElementById('copy-feedback');

        if (copyButton && apiUrlDisplay && copyFeedback) {
            copyButton.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(apiUrlDisplay.value);
                    copyFeedback.classList.add('show');
                    setTimeout(() => {
                        copyFeedback.classList.remove('show');
                    }, 2000);
                } catch (err) {
                    console.error('복사 실패: ', err);
                }
            })
        }
    }

    fetch(`${url.filter}`)
        .then(response => {
            if (!response.ok) {
                throw new Error("데이터 조회에 실패했습니다.\n잠시 후 다시 시도해주세요.");
            }
            return response.json();
        })
        .then(data => {
            initializeFilters(pageFilterConfig, data, performSearch);
        })
        .catch(error => {
            console.error("검색 중 오류 발생:", error);
        });

    addPageSizeChangeEventListener();
    addCopyButtonEventListener();
</script>
</body>

</html>
